name: CI

on:
  push:
  workflow_dispatch:

jobs:
  # Slacké–‹å§‹é€šçŸ¥
  slackStartNotification:
    name: Slack-Start-Notification
    runs-on: ubuntu-latest
    env:
      SLACK_USERNAME: Github Actions
      SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      - name: Notify Start of CI
        uses: rtCamp/action-slack-notify@v2
        env:
          SLACK_TITLE: Deploy / Start
          SLACK_COLOR: warning
          SLACK_MESSAGE: ${{ github.ref_name }} ãƒ–ãƒ©ãƒ³ãƒã®CIã‚’é–‹å§‹ã—ã¾ã™ğŸ› ï¸
  # å‹ãƒã‚§ãƒƒã‚¯
  TypeCheck:
    needs: slackStartNotification
    runs-on: ubuntu-latest
    steps:
      # ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
      - uses: actions/checkout@v4
      # Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          cache: 'npm'
      # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¯Linux/macOSã§ã¯`~/.npm`ã«ä¿å­˜ã•ã‚Œã‚‹
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã€node_modulesã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list
      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci
      # å‹ãƒã‚§ãƒƒã‚¯ã‚’å®Ÿè¡Œ
      - name: Run TypeCheck
        run: npm run typecheck

  # ãƒ“ãƒ«ãƒ‰ãƒã‚§ãƒƒã‚¯
  Build:
    needs: TypeCheck
    runs-on: ubuntu-latest
    steps:
      # ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
      - uses: actions/checkout@v4
      # Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          cache: 'npm'
      # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¯Linux/macOSã§ã¯`~/.npm`ã«ä¿å­˜ã•ã‚Œã‚‹
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã€node_modulesã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list
      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci
      # ãƒ“ãƒ«ãƒ‰ã‚’å®Ÿè¡Œ
      - name: Run Build
        run: npm run build

  # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆ
  UnitTest:
    needs: Build
    runs-on: ubuntu-latest
    steps:
      # ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
      - uses: actions/checkout@v4
      # Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          cache: 'npm'
      # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¯Linux/macOSã§ã¯`~/.npm`ã«ä¿å­˜ã•ã‚Œã‚‹
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã€node_modulesã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list
      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci
      # ãƒ¦ãƒ‹ãƒƒãƒˆãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: Run Unit Test
        run: npm run test

  # E2Eãƒ†ã‚¹ãƒˆ
  E2ETest:
    needs: Build
    runs-on: ubuntu-latest
    env:
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®è¨­å®š
      DATABASE_URL: postgresql://postgres:postgres@localhost:5432/postgres
      # Auth.jsã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã‚­ãƒ¼ã®è¨­å®š
      AUTH_SECRET: ${{ secrets.AUTH_SECRET }}
    services:
      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ã‚³ãƒ³ãƒ†ãƒŠã‚’èµ·å‹•
      postgres:
        image: postgres:16
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼åã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åã®è¨­å®š
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯ã®è¨­å®š
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®ãƒãƒ¼ãƒˆã®è¨­å®š
        ports:
          - 5432:5432
    steps:
      # ãƒ–ãƒ©ãƒ³ãƒã‚’å–å¾—
      - uses: actions/checkout@v4
      # Node.jsã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–
          cache: 'npm'
      # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥è¨­å®š
      - name: Cache node modules
        id: cache-npm
        uses: actions/cache@v4
        env:
          cache-name: cache-node-modules
        with:
          # npmã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãƒ•ã‚¡ã‚¤ãƒ«ã¯Linux/macOSã§ã¯`~/.npm`ã«ä¿å­˜ã•ã‚Œã‚‹
          path: ~/.npm
          key: ${{ runner.os }}-build-${{ env.cache-name }}-${{ hashFiles('**/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-build-${{ env.cache-name }}-
            ${{ runner.os }}-build-
            ${{ runner.os }}-
      # ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒãƒ’ãƒƒãƒˆã—ãªã‹ã£ãŸå ´åˆã€node_modulesã®çŠ¶æ…‹ã‚’è¡¨ç¤º
      - if: ${{ steps.cache-npm.outputs.cache-hit != 'true' }}
        name: List the state of node modules
        continue-on-error: true
        run: npm list
      # ä¾å­˜ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install dependencies
        run: npm ci
      # Playwrightã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      - name: Install Playwright
        run: npx playwright install --with-deps
      # Prismaã®ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã‚’å®Ÿè¡Œ
      - name: Run Prisma migrate
        run: npx prisma migrate deploy
      # è‡ªå‹•ã§OAuthèªè¨¼ï¼ˆGoogleï¼‰ã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’ã‚·ãƒ¼ãƒ‰
      - name: Seed test data
        run: psql -h localhost -U postgres -d postgres -f ./prisma/seed.sql
        env:
          PGPASSWORD: postgres
      # ã‚·ãƒ¼ãƒ‰ã—ãŸãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ç¢ºèª
      - name: Verify Seed Data
        run: |
          psql -h localhost -U postgres -d postgres -c "SELECT * FROM \"User\" WHERE id = 'testId';"
          psql -h localhost -U postgres -d postgres -c "SELECT * FROM \"Session\" WHERE \"userId\" = 'testId';"
          psql -h localhost -U postgres -d postgres -c "SELECT * FROM \"Balance\" WHERE \"userId\" = 'testId';"
        env:
          PGPASSWORD: postgres
      # E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      - name: Run E2E Test
        run: npm run playwright

  # Slacké€šçŸ¥
  SlackEndNotification:
    name: Slack-End-Notification
    runs-on: ubuntu-latest
    needs: [TypeCheck, Build, UnitTest, E2ETest]
    env:
      SLACK_USERNAME: Github Actions
      SLACK_ICON: https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png
      SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK_URL }}
    steps:
      # æˆåŠŸ
      - name: Slack Notification on Success
        uses: rtCamp/action-slack-notify@v2
        if: ${{ success() }}
        env:
          SLACK_TITLE: Deploy / Success
          SLACK_COLOR: good
          SLACK_MESSAGE: ${{ github.ref_name }}ãƒ–ãƒ©ãƒ³ãƒã®CIãŒæˆåŠŸã—ã¾ã—ãŸğŸš€

      # å¤±æ•—
      - name: Slack Notification on Failure
        uses: rtCamp/action-slack-notify@v2
        if: ${{ failure() }}
        env:
          SLACK_TITLE: Deploy / Failure
          SLACK_COLOR: danger
          SLACK_MESSAGE: ${{ github.ref_name }}ãƒ–ãƒ©ãƒ³ãƒã®CIãŒå¤±æ•—ã—ã¾ã—ãŸğŸ˜¢
